// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
      provider = "prisma-client-js"
}

datasource db {
      provider = "postgresql"
}


model User {
      id                Int             @id @default(autoincrement())
      email             String          @unique
      name              String?
      createdAt         DateTime        @default(now())
      updatedAt         DateTime

      createdProducts   Product[]       @relation("creator")
      saleableProducts  Product[]       @relation("seller")

      orders            Order[]
      cart              Cart?

      @@map("user")
}


model Product {
      id                Int             @id @default(autoincrement())
      slug              String          @unique
      sku               String          @unique
      barcode           String?         @unique
      status            String
      price             Int?
      salePrice         Int?
      startSale         DateTime?
      endSale           DateTime?

      creatorId         Int
      creator           User            @relation("creator", fields: [creatorId], references: [id])

      stockQuantity     Int?
      inStock           Boolean?
      weight            Int?
      description       String?
      shortDescription  String?
      createdAt         DateTime        @default(now())

      brandId           Int?
      brand             Brand?          @relation(fields: [brandId], references: [id])

      sellerId          Int
      seller            User            @relation("seller", fields: [sellerId], references: [id])

      categories        ProductCategory[]

      attributeValues   ProductAttributeValue[]

      

      cartItems         CartItem[]
      @@map("product")
}


model Attribute {
      id                Int             @id @default(autoincrement())
      name              String         
      slug              String          @unique 
      type              String          @default("text") 
      
      options           AttributeOption[] 
      values            ProductAttributeValue[] 

      @@map("attribute")
}


model AttributeOption {
      id                Int             @id @default(autoincrement())
      label             String  
      value             String
      attributeId       Int
      attribute         Attribute       @relation(fields: [attributeId], references: [id])
  
      productValues     ProductAttributeValue[]

      @@map("attribute_option")
}

model ProductAttributeValue {
      id                Int             @id @default(autoincrement())
      productId         Int
      product           Product         @relation(fields: [productId], references: [id])
  
      attributeId       Int
      attribute         Attribute       @relation(fields: [attributeId], references: [id])
  
      optionId          Int?
      option            AttributeOption? @relation(fields: [optionId], references: [id])
  
  
      value             String? 

      @@map("product_attribute_value")
}

model ProductCategory {
      productId         Int
      categoryId        Int
      isPrimary         Boolean?        @default(false)  // مثلاً دسته اصلی
      sortOrder         Int?                      // ترتیب نمایش

      product           Product         @relation(fields: [productId], references: [id])
      category          Category        @relation(fields: [categoryId], references: [id])

      @@id([productId, categoryId])     // کلید اصلی ترکیبی
      @@map("product_category")
}




model Cart {
      id                Int             @id @default(autoincrement())
      customerId        Int             @unique
      customer          User            @relation(fields: [customerId], references: [id])

      cartItems         CartItem[]

      @@map("cart")
}

model CartItem {
      id                Int             @id @default(autoincrement())

      cartId            Int
      cart              Cart            @relation(fields: [cartId], references: [id])

      productId         Int
      product           Product         @relation(fields: [productId], references: [id])

      quantity          Int

      @@map("cart_item")
}

model Shipping {
      id                Int             @id @default(autoincrement())

      orderId           String             @unique
      order             Order           @relation(fields: [orderId], references: [id])

      address           String
      latitude          Int?
      longitude         Int?

      method            String
      trackingCode    String

      @@map("shipping")
      
}


model Brand {
      id                Int             @id @default(autoincrement())
      slug              String          @unique
      name              String          @unique
      image             String?
      products          Product[]

      @@map("brand")
}


model Tag {
      id                Int             @id @default(autoincrement())
      slug              String          @unique
      name              String          @unique
      image             String?
      description       String?

      @@map("tag")
}


model Category {
      id                Int             @id @default(autoincrement())
      slug              String          @unique
      name              String          @unique
      image             String?
      description       String?

      // رابطه به والد (parent) - اختیاری چون دسته‌های ریشه parent ندارن
      parentId          Int?     
      parent            Category? @relation("CategoryTree", fields: [parentId], references: [id])

      // رابطه به فرزندها (children) - همه فرزندهای مستقیم این دسته
      children          Category[] @relation("CategoryTree")

      products          ProductCategory[]

      @@map("category")
}


model Order {
      id                String          @id @default(uuid())
      orderNumber       String          @unique
      status            String
      paymentStatus     String   
      paymentMethod     String
      itemsTotal        BigInt          @default(0)     // مجموع قیمت کالاها قبل از تخفیف
      discountTotal     BigInt          @default(0)     // مجموع تخفیف‌ها
      shippingCost      BigInt          @default(0)     // هزینه ارسال
      taxTotal          BigInt          @default(0)     // مالیات (در صورت نیاز)
      totalAmount       BigInt
      
      customerId        Int
      customer          User            @relation(fields: [customerId], references: [id])

      shipping          Shipping?
      orderItems        OrderItem[]

      @@map("order")
}


model OrderItem {
      id                String          @id @default(uuid())

      orderId           String
      order             Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)

      productId         String
      variantId         String?         // اگر محصول رنگ/سایز دارد

      // اسنپ‌شات محصول در زمان خرید (خیلی مهم!)
      title             String
      thumbnail         String?
      price             Int   
      salePrice         Int             // قیمت واحد در زمان خرید (بعد از تخفیف محصول)
      discount          Int
      extraId           Int             // مثلا شماره فاکتور سپیدار
      taxClass          String
      quantity          Int

      @@map("order_item")
}